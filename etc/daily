#!/bin/sh -
#
#	$OpenBSD: daily,v 1.16 1997/01/03 22:51:26 millert Exp $
#
PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/local
host=`hostname -s`
echo "Subject: $host daily run output"

if [ -f /etc/daily.local ];then
	echo ""
	echo "Running daily.local:"
	. /etc/daily.local
fi

TMP=`mktemp /tmp/_daily.XXXXXX` || exit 1

trap 'rm -f $TMP' 0 1 15

echo ""
echo "NOT Removing scratch and junk files."
#echo "Removing scratch and junk files:"
# XXX NOT REMOVING UNTIL SECURITY BUG IS FIXED" 
#if [ -d /tmp -a ! -h /tmp ]; then
#	cd /tmp && {
#	find . -type f -atime +3 -exec rm -f -- {} \;
#	find . ! -name . -type d -mtime +1 -exec rmdir -- {} \; \
#	    >/dev/null 2>&1; }
#fi

# XXX NOT REMOVING UNTIL SECURITY BUG IS FIXED 
#if [ -d /var/tmp -a ! -h /var/tmp ]; then
#	cd /var/tmp && {
#	find . ! -name . -atime +7 -exec rm -f -- {} \;
#	find . ! -name . -type d -mtime +1 -exec rmdir -- {} \; \
#	    >/dev/null 2>&1; }
#fi

# Additional junk directory cleanup would go like this:
#if [ -d /scratch -a ! -h /scratch ]; then
#	cd /scratch && {
#	find . ! -name . -atime +1 -exec rm -f -- {} \;
#	find . ! -name . -type d -mtime +1 -exec rmdir -- {} \; \
#	    >/dev/null 2>&1; }
#fi

#if [ -d /var/rwho -a ! -h /var/rwho ] ; then
#	cd /var/rwho && {
# XXX NOT REMOVING UNTIL SECURITY BUG IS FIXED 
#	find . ! -name . -mtime +7 -exec rm -f -- {} \; ; }
#fi

find / \( ! -fstype local -o -fstype rdonly -o -fstype fdesc \
		-o -fstype kernfs -o -fstype procfs \) -a -prune -o \
	-name 'lost+found' -a -prune -o \
	-name '*.core' -a -print > $TMP
#	\( -name '[#,]*' -o -name '.#*' -o -name a.out \
#	   -o -name '*.CKP' -o -name '.emacs_[0-9]*' \) \
#		-a -atime +3 -exec rm -f -- {} \; -a -print > $TMP

if egrep -q '\.core$' $TMP; then
    echo ""
    echo "Possible core dumps:"
    egrep '\.core$' $TMP

    # XXX - we aren't deleting files due to security bug mentioned above
    #echo ""
    #echo "Deleted files:"
    #egrep -v '\.core$' $TMP
fi

msgs -c

if [ -f /etc/news.expire ]; then
	/etc/news.expire
fi

if [ -f /var/account/acct ]; then
	echo "" ;
	echo "Purging accounting records:" ;
	mv /var/account/acct.2 /var/account/acct.3 ;
	mv /var/account/acct.1 /var/account/acct.2 ;
	mv /var/account/acct.0 /var/account/acct.1 ;
	cp /var/account/acct /var/account/acct.0 ;
	sa -sq ;
fi

echo ""
if [ -d /var/yp/binding -a ! -d /var/yp/`domainname` ]; then 
	echo "Not running calendar, (yp client)."
else
	echo "Running calendar."
	calendar -a
fi

# Rotation of mail log now handled automatically by cron and 'newsyslog'

if [ -d /var/spool/uucp -a -f /etc/uuclean.daily ]; then
	echo ""
	echo "Cleaning up UUCP:"
	echo /etc/uuclean.daily | su daemon
fi

echo ""
echo "Checking subsystem status:"
echo ""
echo "disks:"
df -k
echo ""
dump W
echo ""

mailq > $TMP
if ! grep -q "^Mail queue is empty$" $TMP; then
	echo ""
	echo "mail:"
	cat $TMP
fi

if [ -d /var/spool/uucp ]; then
	uustat -a > $TMP
	if [ -s $TMP ]; then
		echo ""
		echo "uucp:"
		cat $TMP
	fi
fi

echo ""
echo "network:"
netstat -i
echo ""

t=/var/rwho/*
if [ "$t" != '/var/rwho/*' ]; then
	ruptime
fi

echo ""
echo "NOT checking filesystems."
#echo "Checking filesystems:"
#fsck -n | grep -v '^\*\* Phase'

echo ""
if [ -f /etc/Distfile ]; then
	echo "Running rdist:"
	rdist -f /etc/Distfile
fi

sh /etc/security 2>&1 | mail -s "$host daily insecurity output" root
